<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.nt.service_BASF.mapper.PimsdataMapper">
    <resultMap id="BaseResultMap" type="com.nt.dao_BASF.Pimsdata">
        <!--
           WARNING - @mbg.generated
         -->
        <id column="pimsid" property="pimsid" jdbcType="VARCHAR"/>
        <result column="equipment" property="equipment" jdbcType="VARCHAR"/>
        <collection property="rows" ofType="com.nt.dao_BASF.VO.PimsdataVo">
            <result column="pimspointname" property="pimspointname" jdbcType="VARCHAR"/>
            <result column="pimsdata" property="pimsdata" jdbcType="DECIMAL"/>
            <result column="type" property="type" jdbcType="VARCHAR"/>
            <result column="CREATEON" property="createon" jdbcType="TIMESTAMP"/>
        </collection>
    </resultMap>
    <select id="getAllPimsInfo" resultMap="BaseResultMap">
        SELECT
        MAX(dcode.pointid) pimsid,
        MAX(dcode.equipment) equipment,
        detail.pimspointname pimspointname,
        group_concat(detail.pimsdata) pimsdata,
        group_concat(detail.time ORDER BY detail.CREATEON) CREATEON,
        MAX(detail.type) type
        FROM
        (
        SELECT
        MAX(id) pointid,
        equipment
        FROM
        pimspoint
        GROUP BY
        equipment
        ) dcode
        LEFT JOIN (
        SELECT
        MAX(point.equipment) equipment,
        pd.monitoringpoint,
        MAX(point.pimspointname) pimspointname,
        IF(LOCATE(",",group_concat( pd.pimsdata ORDER BY pd.CREATEON desc )) = 0,group_concat( pd.pimsdata ORDER BY pd.CREATEON desc ),SUBSTRING_INDEX(group_concat( pd.pimsdata ORDER BY pd.CREATEON desc ),",",1)) pimsdata,
        MAX( pd.CREATEON ) CREATEON,
        MAX( point.type ) type,
        DATE_FORMAT(
        concat( date(MAX( pd.CREATEON )), ' ', HOUR (MAX( pd.CREATEON )), ':', floor( MINUTE (MAX( pd.CREATEON )) / 10 ) * 10 ),
        '%H:%i'
        ) AS time
        FROM
        pimsdata pd
        LEFT JOIN
        pimspoint point
        ON pd.monitoringpoint = point.id
        WHERE
        TO_DAYS( pd.CREATEON ) = TO_DAYS(
        NOW())
        AND HOUR(pd.CREATEON) &gt;= ${hourStart}
        AND HOUR(pd.CREATEON) &lt;= ${hourEnd}
        AND point.type = #{type}
        GROUP BY
        pd.monitoringpoint,
        DATE_FORMAT(
        concat( date(pd.CREATEON), ' ', HOUR (pd.CREATEON), ':', floor( MINUTE (pd.CREATEON) / 10 ) * 10 ),
        '%H:%i'
        )
        ) detail ON dcode.equipment = detail.equipment
        WHERE detail.monitoringpoint IS NOT NULL
        GROUP BY detail.pimspointname
    </select>

    <select id="getLastestPims" resultType="com.nt.dao_BASF.Pimsdata">
        SELECT
            a.monitoringpoint,
        IF
            (
                LOCATE(
                    ",",
                group_concat( a.pimsdata ORDER BY a.createon DESC )) = 0,
                group_concat( a.pimsdata ORDER BY a.createon DESC ),
            SUBSTRING_INDEX( group_concat( a.pimsdata ORDER BY a.createon DESC ), ",", 1 )) pimsdata
        FROM
            ( SELECT * FROM pimsdata ORDER BY createon DESC) a
        GROUP BY
            a.monitoringpoint
    </select>

    <insert id="insertPimsDataList" parameterType="java.util.List">
        insert into pimsdata
        (
            pimsid,
            monitoringpoint,
            pimsdata,
            `status`,
            createon,
            createby,
            modifyon,
            modifyby,
            `owner`,
            tenantid
        )
        values
        <foreach collection="list" item="pd" index="index" separator=",">
            (
                #{pd.pimsid},
                #{pd.monitoringpoint},
                #{pd.pimsdata},
                #{pd.status},
                #{pd.createon},
                #{pd.createby},
                #{pd.modifyon},
                #{pd.modifyby},
                #{pd.owner},
                #{pd.tenantid}
            )
        </foreach>

    </insert>
</mapper>
