<?xml version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.nt.service_pfans.PFANS5000.mapper.CompanyProjectsMapper">

	<select id="getList" resultType="com.nt.dao_Pfans.PFANS5000.Vo.CompanyProjectsVo2">
		select
			c.`PROJECT_NAME` as project_name,
			c.`NUMBERS` as numbers,
			s.`PHASE` as phase,
			s.`PRODUCTSTATUS` as productstatus,
			<![CDATA[ case when s.`COMPANYPROJECTS_ID` != "" && s.`ESTIMATEDENDTIME` < s.`ACTUALSTARTTIME`  ]]> then '0'
			when s.`COMPANYPROJECTS_ID` != "" then '1'
			ELSE '' END as phasestatus,
			s.`ESTIMATEDWORK` as estimatedwork,
			s.`ACTUALWORK` as actualwork,
			<![CDATA[ case when a.CONTRACTAPPLICATION_ID != "" && (curdate() < substring(a.CLAIMDATETIME,1,10) || curdate() > substring(a.CLAIMDATETIME,14,10))  ]]> then '0'
			<![CDATA[ when a.CONTRACTAPPLICATION_ID != "" && curdate() >= substring(a.CLAIMDATETIME,1,10) && curdate() <= substring(a.CLAIMDATETIME,14,10)  ]]> then '1'
			else '2' end as contractstatus,
			c.`STATUS` as status,
			c.`COMPANYPROJECTS_ID` as companyprojects_id
		from `companyprojects` c
		left outer join `stageinformation` s
		on c.`COMPANYPROJECTS_ID` = s.`COMPANYPROJECTS_ID`
		and s.status = '0'
		and
		<![CDATA[ s.ACTUALSTARTTIME <= curdate()
		and (curdate() <= s.ACTUALENDTIME || ISNULL(s.ACTUALENDTIME)) ]]>
		left outer join `projectcontract` p
		on c.`COMPANYPROJECTS_ID` = p.`COMPANYPROJECTS_ID`
		and p.status = '0'
		left outer join contractapplication a
		on a.CONTRACTAPPLICATION_ID = p.CONTRACT
		and a.status = '0'
		where c.`STATUS` != '1'
		order by c.`CREATEON` desc
	</select>

</mapper>
