<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.nt.service_pfans.PFANS1000.mapper.PltabMapper">
    <select id="getPltab" resultType="com.nt.dao_Pfans.PFANS1000.Pltab">
        select a.PROJECT_NAME as pj,
       sum(CASE a.code WHEN 'HT008006' THEN a.rmb ELSE 0 END) AS 'outst1',
       sum(CASE a.code WHEN 'HT008008' THEN a.rmb ELSE 0 END) AS 'outst2',
       sum(CASE a.code WHEN 'HT008009' THEN a.rmb ELSE 0 END) AS 'outst3',
       sum(CASE a.code WHEN 'neibu' THEN a.rmb ELSE 0 END) AS 'outcost',
       sum(CASE a.code WHEN 'PJ111001' THEN a.rmb ELSE 0 END) AS 'twocost',
       sum(CASE a.code WHEN 'PJ111002' THEN a.rmb ELSE 0 END) AS 'rent',
       sum(CASE a.code WHEN 'PJ111003' THEN a.rmb ELSE 0 END) AS 'leasecost',
       sum(CASE a.code WHEN 'PJ111004' THEN a.rmb ELSE 0 END) AS 'temporaryrent',
       sum(CASE a.code WHEN 'PJ111005' THEN a.rmb ELSE 0 END) AS 'other',
       sum(CASE a.code WHEN 'PJ111006' THEN a.rmb ELSE 0 END) AS 'researchcost',
       sum(CASE a.code WHEN 'PJ111007' THEN a.rmb ELSE 0 END) AS 'yuanqincost',
       sum(CASE a.code WHEN 'PJ111008' THEN a.rmb ELSE 0 END) AS 'travalcost',
       sum(CASE a.code WHEN 'PJ111009' THEN a.rmb ELSE 0 END) AS 'callcost',
       sum(CASE a.code WHEN 'PJ111010' THEN a.rmb ELSE 0 END) AS 'concost',
	   sum(CASE a.code WHEN 'PJ111011' THEN a.rmb ELSE 0 END) AS 'threefree',
	   sum(CASE a.code WHEN 'PJ111012' THEN a.rmb ELSE 0 END) AS 'commonfee',
       sum(CASE a.code WHEN 'PJ111013' THEN a.rmb ELSE 0 END) AS 'brandcost',
       sum(CASE a.code WHEN 'PJ111014' THEN a.rmb ELSE 0 END) AS 'otherexpenses',
       sum(CASE a.code WHEN 'WORKTIME' THEN a.rmb ELSE 0 END) AS 'emhours',
       sum(CASE a.code WHEN 'WORKTIME0' THEN a.rmb ELSE 0 END) AS 'inhours',
       sum(CASE a.code WHEN 'WORKTIMEEX' THEN a.rmb ELSE 0 END) AS 'outhours',
       sum(CASE a.code WHEN 'neibuhetong' THEN a.rmb ELSE 0 END) AS 'inwetuo',
	   sum(CASE a.code WHEN 'neibuhetong' THEN a.rmb ELSE 0 END) AS 'inst'
    from
(
select code, sum(rmb) as rmb,pj.PROJECT_NAME  from (
select d.CODE, (IFNULL(SUM(tao.RMB), 0) + IFNULL(SUM(tao.tormb), 0)) as rmb,cp.PROJECT_NAME
from (
select `CODE` from dictionary where PCODE = 'PJ111'
) as d left join publicexpense p on 1=1
left join (
		select rmb,tormb,PUBLICEXPENSE_ID,PLSUMMARY,SUBJECTNUMBER,DEPARTMENTNAME from trafficdetails
		union all
		SELECT rmb,tormb,PUBLICEXPENSE_ID,PLSUMMARY,SUBJECTNUMBER,DEPARTMENTNAME from purchasedetails
		union all
		SELECT rmb,tormb,PUBLICEXPENSE_ID,PLSUMMARY,SUBJECTNUMBER,DEPARTMENTNAME from otherdetails
		) tao
                   on p.PUBLICEXPENSE_ID = tao.PUBLICEXPENSE_ID
                       and tao.PLSUMMARY = d.CODE
                     and tao.DEPARTMENTNAME = #{groupid}
										 and tao.SUBJECTNUMBER  not in ('1099-A1-0000','0504-00-0000')
				 left join companyprojects cp
                    on p.PROJECT_ID = cp.COMPANYPROJECTS_ID
 where year(p.REIMBURSEMENTDATE) = #{year} and month(p.REIMBURSEMENTDATE) = #{month}
group by d.CODE,cp.PROJECT_NAME
union all
select 'PJ111008' as code, (IFNULL(SUM(ta.RMB), 0)) as rmb,companyprojects.PROJECT_NAME
from evection e
		left join (
		select rmb,EVECTION_ID,PLSUMMARY,SUBJECTNUMBER,DEPARTMENTNAME from trafficdetails
		union all
		SELECT rmb,EVECTION_ID,PLSUMMARY,SUBJECTNUMBER,DEPARTMENTNAME from accommodationdetails
		) ta
		 on e.EVECTION_ID = ta.EVECTION_ID
                       and ta.PLSUMMARY  = 'PJ111008'
											 and ta.SUBJECTNUMBER not in ('1099-A1-0000','0504-00-0000')
                    and ta.DEPARTMENTNAME = #{groupid}
				 left join companyprojects
                    on e.PROJECT_ID = companyprojects.COMPANYPROJECTS_ID
 where year(e.REIMBURSEMENTDATE) = #{year} and month(e.REIMBURSEMENTDATE) = #{month}
 group by code,companyprojects.PROJECT_NAME
) pj group by code,PROJECT_NAME

union all
select
case
when contracttype = 'HT008009' then 'HT008009'
when contracttype in ("HT008007","HT008008") then 'HT008008'
when contracttype in ("HT008001","HT008002","HT008003","HT008004","HT008005","HT008006") then 'HT008006'
else NULL
end as contracttype1,
cast(SUM(cn.CLAIMAMOUNT)AS decimal(15,2)) as rmb,companyprojects.PROJECT_NAME
from contractapplication ca
inner join contractnumbercount cn
on ca.CONTRACTNUMBER = cn.CONTRACTNUMBER
inner join projectcontract
on projectcontract.CONTRACT = ca.CONTRACTNUMBER
inner join companyprojects
on companyprojects.COMPANYPROJECTS_ID = projectcontract.COMPANYPROJECTS_ID
where ca.state= '有效'
and ca.type = "1"
and ca.GROUP_ID = #{groupid}
and year(cn.DELIVERYDATE) = #{year} and month(cn.DELIVERYDATE) = #{month}
GROUP BY contracttype1,companyprojects.PROJECT_NAME
having contracttype1 is not null

union all
select 'WORKTIME' as `code`,cast(sum(l.TIME_START) AS decimal(15,2)) as worktime,c.PROJECT_NAME from logmanagement l
inner join companyprojects c
on l.PROJECT_ID = c.COMPANYPROJECTS_ID
where c.GROUP_ID = #{groupid}
and year(l.LOG_DATE) = #{year}
and month(l.LOG_DATE) = #{month}
 group by `code`,c.PROJECT_NAME

union all
select 'WORKTIMEEX' as `code`,cast(sum(l.TIME_START) AS decimal(15,2)) as worktime,c.PROJECT_NAME from logmanagement l
inner join companyprojects c
on l.PROJECT_ID = c.COMPANYPROJECTS_ID
inner join expatriatesinfor e
on e.ACCOUNT = l.owner
where c.GROUP_ID = #{groupid}
and year(l.LOG_DATE) = #{year}
and month(l.LOG_DATE) = #{month}
 group by `code`,c.PROJECT_NAME

union all
select "neibu" as code,cast((sum(cost.COST4) + sum(cost.COST5) + sum(cost.COST6) + sum(cost.COST7) + sum(cost.COST8) + sum(cost.COST9) +sum(cost.COST10) + sum(cost.COST11) + sum(cost.COST12) + sum(cost.COST1) + sum(cost.COST2) + sum(cost.COST3)) AS decimal(15,2)) as rmb,cp.PROJECT_NAME
from coststatistics cost
inner join expatriatesinfor exp
  on cost.BPNAME = exp.EXPATRIATESINFOR_ID
inner join projectsystem ps
  on ps.`NAME` = exp.ACCOUNT
inner join companyprojects cp
  on ps.COMPANYPROJECTS_ID = cp.COMPANYPROJECTS_ID
where cp.GROUP_ID = #{groupid}
group by cost.BPCOMPANY,code,cp.PROJECT_NAME

union all
select 'neibuhetong' as code,cast(sum(CLAIMAMOUNT) AS decimal(15,2)) as rmb, company.PROJECT_NAME
from contractnumbercount contract
inner join companyprojects company
on company.COMPANYPROJECTS_ID = contract.COMPANYPROJECTSID
where company.GROUP_ID = #{groupid}
and year(contract.DELIVERYDATE) = #{year} and month(contract.DELIVERYDATE) = #{month}
GROUP BY code,company.PROJECT_NAME
) a
group by pj
    </select>
    <select id="getCMPJ" resultType="com.nt.dao_Pfans.PFANS5000.LogManagement">
       select * from logmanagement
       where PROJECT_ID = 'PP024001'
      and month(CREATEON) = #{month}
      and year(CREATEON) = #{year}
    </select>

</mapper>

