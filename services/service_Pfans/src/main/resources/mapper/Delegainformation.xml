<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.nt.service_pfans.PFANS6000.mapper.DelegainformationMapper">
    <select id="getYears" parameterType="com.nt.dao_Pfans.PFANS6000.Delegainformation"
            resultType="com.nt.dao_Pfans.PFANS6000.Vo.DelegainformationVo">
         select
            de.delegainformation_id,
            dep.year,
            dep.group_id,
            dep.account,
            dep.companyprojects_id,
            dep.projectsystem_id,
            dep.project_name,
            dep.managerid,
            dep.suppliername,
            dep.expname,
            dep.admissiontime,
            dep.exittime,
            dep.operationform,
            dep.jobclassification,
            case when de.april is not null or de.april != '' or if(isnull(de.april),'0',de.april) != '0' then de.april else dep.april end as april,
            case when de.may is not null or de.may != ''  or if(isnull(de.may),'0',de.may) != '0' then de.may else dep.may end as may,
            case when de.june is not null or de.june != ''  or if(isnull(de.june),'0',de.june) != '0' then de.june else dep.june end as june,
            case when de.july is not null or de.july != ''  or if(isnull(de.july),'0',de.july) != '0' then de.july else dep.july end as july,
            case when de.august is not null or de.august != ''  or if(isnull(de.august),'0',de.august) != '0' then de.august else dep.august end as august,
            case when de.september is not null or de.september != ''  or if(isnull(de.september),'0',de.september) != '0' then de.september else dep.september end as september,
            case when de.october is not null or de.october != ''  or if(isnull(de.october),'0',de.october) != '0' then de.october else dep.october end as october,
            case when de.november is not null or de.november != ''  or if(isnull(de.november),'0',de.november) != '0' then de.november else dep.november end as november,
            case when de.december is not null or de.december != ''  or if(isnull(de.december),'0',de.december) != '0' then de.december else dep.december end as december,
            case when de.january is not null or de.january != ''  or if(isnull(de.january),'0',de.january) != '0' then de.january else dep.january end as january,
            case when de.february is not null or de.february != ''  or if(isnull(de.february),'0',de.february) != '0' then de.february else dep.february end as february,
            case when de.march is not null or de.march != ''  or if(isnull(de.march),'0',de.march) != '0' then de.march else dep.march end as march,
            dep.remarks,
            dep.alltechnology,
            dep.assitevaluation,
            dep.exitreason,
            dep.businessimpact,
            dep.countermeasure,
            dep.distriobjects,
            dep.venuetarget
            from (
            select
                #{year} as year,
                log.group_id,
                ex.account,
                log.project_id as companyprojects_id,
                sys.projectsystem_id,
                case when log.project_id = 'PP024001' then log.project_name else pro.project_name end as project_name,
                pro.managerid,
                ex.suppliername,
                expname,
                sys.admissiontime,
                sys.exittime,
                op.value1 as operationform,
                jo.value1 as jobclassification,
                log.april,
                log.may,
                log.june,
                log.july,
                log.august,
                log.september,
                log.october,
                log.november,
                log.december,
                log.january,
                log.february,
                log.march,
                remarks,
                al.value1 as alltechnology,
                si.value1 assitevaluation,
                exi.value1 as exitreason,
                bu.value1 as businessimpact,
                cou.value1 as countermeasure,
                case when distriobjects = '0' then '是' when distriobjects = '1' then '否' end as distriobjects,
                case when venuetarget = '0' then '是' when venuetarget = '1' then '否' end as venuetarget
            from
            (
                select group_id,project_id,project_name,createby,
                case when round(april/8/21.75,2) >= 1 then 1 else round(april/8/21.75,2) end april,
                case when round(may/8/21.75,2) >= 1 then 1 else round(may/8/21.75,2) end  may,
                case when round(june/8/21.75,2) >= 1 then 1 else round(june/8/21.75,2) end june,
                case when round(july/8/21.75,2) >= 1 then 1 else round(july/8/21.75,2) end july,
                case when round(august/8/21.75,2) >= 1 then 1 else round(august/8/21.75,2) end august,
                case when round(september/8/21.75,2) >= 1 then 1 else round(september/8/21.75,2) end september,
                case when round(october/8/21.75,2) >= 1 then 1 else round(october/8/21.75,2) end october,
                case when round(november/8/21.75,2) >= 1 then 1 else round(november/8/21.75,2) end november,
                case when round(december/8/21.75,2) >= 1 then 1 else round(december/8/21.75,2) end december,
                case when round(january/8/21.75,2) >= 1 then 1 else round(january/8/21.75,2) end january,
                case when round(february/8/21.75,2) >= 1 then 1 else round(february/8/21.75,2) end february,
                case when round(march/8/21.75,2) >= 1 then 1 else round(march/8/21.75,2) end march
                from
                (select expatriatesinfor.group_id,project_id,logmanagement.project_name,logmanagement.createby,
                SUM(CASE DATE_FORMAT(LOG_DATE, '%m') WHEN '04' THEN TIME_START ELSE 0 END) AS april,
                SUM(CASE DATE_FORMAT(LOG_DATE, '%m') WHEN '05' THEN TIME_START ELSE 0 END) AS may,
                SUM(CASE DATE_FORMAT(LOG_DATE, '%m') WHEN '06' THEN TIME_START ELSE 0 END) AS june,
                SUM(CASE DATE_FORMAT(LOG_DATE, '%m') WHEN '07' THEN TIME_START ELSE 0 END) AS july,
                SUM(CASE DATE_FORMAT(LOG_DATE, '%m') WHEN '08' THEN TIME_START ELSE 0 END) AS august,
                SUM(CASE DATE_FORMAT(LOG_DATE, '%m') WHEN '09' THEN TIME_START ELSE 0 END) AS september,
                SUM(CASE DATE_FORMAT(LOG_DATE, '%m') WHEN '10' THEN TIME_START ELSE 0 END) AS october,
                SUM(CASE DATE_FORMAT(LOG_DATE, '%m') WHEN '11' THEN TIME_START ELSE 0 END) AS november,
                SUM(CASE DATE_FORMAT(LOG_DATE, '%m') WHEN '12' THEN TIME_START ELSE 0 END) AS december,
                SUM(CASE DATE_FORMAT(DATE_ADD(LOG_DATE, INTERVAL 1 YEAR), '%m') WHEN '01' THEN TIME_START ELSE 0 END) AS january,
                SUM(CASE DATE_FORMAT(DATE_ADD(LOG_DATE, INTERVAL 1 YEAR), '%m') WHEN '02' THEN TIME_START ELSE 0 END) AS february,
                SUM(CASE DATE_FORMAT(DATE_ADD(LOG_DATE, INTERVAL 1 YEAR), '%m') WHEN '03' THEN TIME_START ELSE 0 END) AS march
                from logmanagement
                left join expatriatesinfor
                ON logmanagement.createby = expatriatesinfor.account
                where DATE_FORMAT(LOG_DATE, '%Y') = #{year}
                <if test="group_id != null and group_id != ''" >
                    and expatriatesinfor.group_id = #{group_id}
                </if>
                and (project_id = 'PP024001' or project_id = '')
                group by expatriatesinfor.group_id,project_id,logmanagement.project_name,logmanagement.createby) ment

                union all

                select group_id,project_id,project_name,createby,
                case when round(april/8/21.75,2) >= 1 then 1 else round(april/8/21.75,2) end april,
                case when round(may/8/21.75,2) >= 1 then 1 else round(may/8/21.75,2) end  may,
                case when round(june/8/21.75,2) >= 1 then 1 else round(june/8/21.75,2) end june,
                case when round(july/8/21.75,2) >= 1 then 1 else round(july/8/21.75,2) end july,
                case when round(august/8/21.75,2) >= 1 then 1 else round(august/8/21.75,2) end august,
                case when round(september/8/21.75,2) >= 1 then 1 else round(september/8/21.75,2) end september,
                case when round(october/8/21.75,2) >= 1 then 1 else round(october/8/21.75,2) end october,
                case when round(november/8/21.75,2) >= 1 then 1 else round(november/8/21.75,2) end november,
                case when round(december/8/21.75,2) >= 1 then 1 else round(december/8/21.75,2) end december,
                case when round(january/8/21.75,2) >= 1 then 1 else round(january/8/21.75,2) end january,
                case when round(february/8/21.75,2) >= 1 then 1 else round(february/8/21.75,2) end february,
                case when round(march/8/21.75,2) >= 1 then 1 else round(march/8/21.75,2) end march
                from
                (select companyprojects.group_id,project_id,logmanagement.project_name,logmanagement.createby,
                SUM(CASE DATE_FORMAT(LOG_DATE, '%m') WHEN '04' THEN TIME_START ELSE 0 END) AS april,
                SUM(CASE DATE_FORMAT(LOG_DATE, '%m') WHEN '05' THEN TIME_START ELSE 0 END) AS may,
                SUM(CASE DATE_FORMAT(LOG_DATE, '%m') WHEN '06' THEN TIME_START ELSE 0 END) AS june,
                SUM(CASE DATE_FORMAT(LOG_DATE, '%m') WHEN '07' THEN TIME_START ELSE 0 END) AS july,
                SUM(CASE DATE_FORMAT(LOG_DATE, '%m') WHEN '08' THEN TIME_START ELSE 0 END) AS august,
                SUM(CASE DATE_FORMAT(LOG_DATE, '%m') WHEN '09' THEN TIME_START ELSE 0 END) AS september,
                SUM(CASE DATE_FORMAT(LOG_DATE, '%m') WHEN '10' THEN TIME_START ELSE 0 END) AS october,
                SUM(CASE DATE_FORMAT(LOG_DATE, '%m') WHEN '11' THEN TIME_START ELSE 0 END) AS november,
                SUM(CASE DATE_FORMAT(LOG_DATE, '%m') WHEN '12' THEN TIME_START ELSE 0 END) AS december,
                SUM(CASE DATE_FORMAT(DATE_ADD(LOG_DATE, INTERVAL 1 YEAR), '%m') WHEN '01' THEN TIME_START ELSE 0 END) AS january,
                SUM(CASE DATE_FORMAT(DATE_ADD(LOG_DATE, INTERVAL 1 YEAR), '%m') WHEN '02' THEN TIME_START ELSE 0 END) AS february,
                SUM(CASE DATE_FORMAT(DATE_ADD(LOG_DATE, INTERVAL 1 YEAR), '%m') WHEN '03' THEN TIME_START ELSE 0 END) AS march
                from logmanagement
                left join companyprojects
                ON logmanagement.project_id = companyprojects.companyprojects_id
                left join expatriatesinfor
                ON logmanagement.createby = expatriatesinfor.account
                where DATE_FORMAT(LOG_DATE, '%Y') = #{year}
                <if test="group_id != null and group_id != ''" >
                    and companyprojects.group_id = #{group_id}
                </if>
                and logmanagement.project_id is not null
                and logmanagement.project_id != 'PP024001'
                and (expatriatesinfor.account is not null or expatriatesinfor.account != '')
                group by companyprojects.group_id,project_id,logmanagement.project_name,logmanagement.createby) ment
            ) log
            left join expatriatesinfor ex
            on ex.account = log.createby
            left join companyprojects pro
            on log.project_id = pro.companyprojects_id
            left join projectsystem sys
            on sys.companyprojects_id = log.project_id
            and sys.name = log.createby
            left join dictionary jo
            on jo.code = ex.jobclassification
            left join dictionary op
            on op.code = ex.operationform
            left join dictionary al
            on al.code = ex.alltechnology
            left join dictionary si
            on si.code = ex.sitevaluation
            left join dictionary exi
            on exi.code = ex.exitreason
            left join dictionary bu
            on bu.code = ex.businessimpact
            left join dictionary cou
            on cou.code = ex.countermeasure
        ) dep
        left join delegainformation de
        on dep.account = de.account
        and dep.companyprojects_id = de.companyprojects_id
        order by dep.expname
    </select>
</mapper>

